---
title: "Arenas lab name checker usage"
author: "Oliver Tam and Julie Lowndes"
date: "6/26/2020"
output: html_document
---

## Introduction

This document is to keep track of our workflow using `name_checker.R`,
a script to check that files conform to the Arenas lab convention: 

We expect 7 sections, each separated by an underscore `_`:

1. Experimental name and researcher initials
2. Experiment date and experiment number
3. Condition and replicate number
4. Dye, antibodies or transcript
5. Image capture date
6. Microscope type
7. Lens, zoom and image number

Example:

`NES-SAI2d15-CS_200514-01_Vehicle-1_DAPI+goPitx3-dk488+rbAldh1-dk555+moTh-dk647_200519_CF_10Xz1-1.tiff`

Where:

- Experiment name & initial: `NES-SAI2d15-CS`. experiment name is NES-SAI2d15, CS is Carmen Salto
- Experiment date and number: `200514-01`. 14 May 2020, number 1
- Condition & replicate: `Vehicle-1`. Vehicle condition, replicate 1
- Dye/antibodies/transcript: `DAPI+goPITX3-dk488+rbALDH1-dk555+moTH-dk647`. Each element separated by `-`, if multiple separated by `+`
- Image capture date: `200520`: 20 May 2020
- Microscope type: `CF`. Confocal microscope 
- Lens, zoom & image number: `10X-z2-3`. 10x lens, 2 zoom, number 3.

## RStudio setup

We already have the repo cloned to our computers. (You can also download it and come to Office Hours next week to get help with setting up GitHub). 

Open the repo from RStudio File > Open Project... or in Finder/Windows Explorer by double-clicking the `NDCN_hackathon.Rproj` file.

Navigate to the "hackathon-arenas-02" folder. (You'll see we've tidied a bit since Hackathon 1).

We will work from this `name_checker_usage.Rmd` document today. It is
an R Markdown document, which combines simple text and R code. You can
use the Table of Contents at the bottom of the file to navigate. And
please add your own notes!

## Code Setup

Download the GitHub folder. Move it somewhere you do your analyses (we can discuss good options later).

Look inside `hackathon-arenas-02` folder: it has a `NDCN_hackathon02.Rproj` file; double-click that .Rproj file to open RStudio to this working directory. We will be working today in RStudio.

We will work from this `arenas_lab_usage.Rmd` document today (also in
`hackathon-arenas-02` folder). It is an R Markdown document, which combines simple text and R code. You can use the Table of Contents at the bottom of the file to navigate. And please add your own notes!

*TODO: if Shanzheng and Carmen use RStudio, can delete `here` requirement for the hackathon because it will automatically work with relative filepaths from the repo*

```{r setup}
## checks if the `here` package is installed, if not, installs 
if(! require(here)){
  install.packages("here")
}

## load libraries
library(here) # load `here` package
```

## How to use it

Run the following code block if you have the `here` package:

```{r source_with_here}
source(here("hackathon-arenas-02","code", "name_checker.R"))
```

If you have trouble with the `here package`, you can copy the
following code into R:

```{r source_no_here eval=FALSE}
source(file.path("hackathon-arenas-02","code", "name_checker.R"))
```

This code gives you a list of parameters that the program would take:

```{r usage}
args(check_file_names)
```

The following are some examples on how we can call this program:

```{r examples eval=FALSE}
results <- check_file_names("my_folder")

results  <- check_file_names("my_folder",print2screen=FALSE)

detailed  <- check_file_names("my_folder",verbose=TRUE)
```

The user provides a folder (`my_folder`) containing files with names
that should be checked. The program that finds all the image files
(ending in .czi .tif or .tiff) and checks their names. 

The first command saves the results to a variable(`results`), and also
prints it to the screen. This is what we will be using for most of
this demo.

The second command saves the results to a variable (`results`), but
doesn't print it to screen. This is useful if you don't want to see
the results on screen (especially if there are 100s of files to
process).

The third command provides more information for each file that it
checked, prints it to screen, and also saves it in a variable
(`detailed`). An example of this will be shown later.

### Oliver's test files

There are 4 TIFF files in `files_oliver`, which are named loosely according to
the Arenas lab convention. We should check if they are named correctly.

```{r oliver_test}
results <- check_file_names(here("hackathon-arenas-02",'files_test'))
```

```{r oliver_test_no_here eval=FALSE}
results <- check_file_names(file.path("hackathon-arenas-02",'files_test'))
```

If we look at the first file checked: 
`NES-SAI2d15-r1-CS_200514-01_DAPI+goPitx3-dk488+rbAldh1-dk555+moTh-dk647_200520_CF_10Xz1-2.tif`

The program suggests that it's not in the right format:

If we try to match the expected sections with the detected sections,
you can see that we appear to be missing the third section (Condition
& replicate). The program will not do anything else, as we want the user
to go in and add the missing information.

For the second file: 
`NES-SAI2d15-r2_JSL_200514-01_GFP-1_DAPI+RbAADC-dk488+shTH-dk555_200520_CF_10Xz1-5.lsm`

Again, the program suggests that it's not in the right format:

If we try to match the expected sections with the detected sections,
you can see that we have an extra section. This time, the researcher's
initial was separated from the experiment name (used a underscore
(`_`) instead of a dash (`-`). Right now, the program will not do anything else, 
as we want the user to go in and try to fix the file name
first.

Something to think about: Is there a way to have the code fix it? How
would it know that the extra field is the researcher's initial?

For the third file:
`NES-SAI2d15-r3-CS_200514-01_GFP-1_DAPI+RbAADC-dk488+shTh-dk555_200520_CF_10Xz1-1.czi`

The program outputs the expected destination folder that the file
should go to. This will be part of the Arenas lab's workflow, where they were hoping to
automatically move files into subfolders based on the information in the first two
sections. The program will print out this information so the user can double-check.

While the program did find all the information needed for the file
name, it also made suggestions to the file name that "better" suits the
nomenclature system. In particular, it is suggesting that the
antibodies to have a two-letter species code that is lowercase (`Rb`
to `rb`, and the target protein to be uppercase (`Th` to `TH`).
We can use this information, in combination with a modified version of
the renaming tool from the last hackathon, to automatically rename these
files if necessary.

For the fourth file:
`NES-SAI2d15-CS_200514-01_Vehicle-1_DAPI+goPITX3-dk488+rbALDH1-dk555+moTH-dk647_200520_CF_10X-z2-3.tif`

Again, the program indicates the folder where the file should go, and
also lets the user know that the file seems to be named correctly.

#### What is it actually checking?

If we take a look at the third file, even though the program says that
it's named correctly, sometimes you might want to check what it's
actually finding. The code also has a way to do this by invoking the
`verbose` option:

```{r verbose}
results  <- check_file_names(here("hackathon-arenas-02","files_oliver","Good_file"),verbose=TRUE)
```

```{r verbose_no_here}
results  <- check_file_names(file.path("hackathon-arenas-02","files_oliver","Good_file"),verbose=TRUE)
```

From the results, you can see that it identified the following:
1. Destination folder
2. Experimental condition
3. Replicate number
4. Dye, antibody or transcripts being detected
5. Date of image capture
6. Type of microscope used
7. Lens used
8. Zoom level
9. Picture number

This information could be used in the future to auto-generate a
metadata file, or provide a way to "randomize" the file names.

### Carmen's test files

We had Carmen from the Arenas lab try to name a few files according to
their nomenclature (which is new), and see how well the program can
help her pick up any issues. As it takes time for people to become
familiar with changes to their workflow, a program like this might
help ease people into the new naming system.

```{r carmen_test}
results <- check_file_names(here("hackathon-arenas-02","files_carmen"))
```

```{r carmen_test_no_here}
results <- check_file_names(file.path("hackathon-arenas-02","files_carmen"))
```

### Checking multiple folders

This program can be used as part of a larger workflow to check
multiple folders.
The following R code lists all the directory in the current folder
(which will include all three folders with image files), and will run
the program on each of those folders.
Furthermore, it will also save the results into a file called
`name_checking_log.txt` that you can look at once all the folders have been checked

```{r multiFolder eval=FALSE}
all_dirs  <-  list.dirs(path=file.path("hackathon-arenas-02"))
for(i in 1:length(all_dirs)){
  logfile  <-  c(paste("Current folder is:",all_dirs[i]),"")
  logfile  <-  c(logfile,check_file_names(all_dirs[i]),print2screen=FALSE)
}

write.table(logfile,file.path("hackathon-arenas-02","name_checking_log.txt"),sep="\n",quote=F,row.names=F,col.names=F)
```
---

## Tweaking the program

Sometimes you find a program that does 99% of what you want from it,
but there's that 1% that you want to change to make it better fit your
workflow. Here, we can take a look at how we might try to make a small
change by adding another piece of code that we found elsewhere.

### Using first letter capitalized instead of all caps

In the antibody section of the file name, we are currently making all
the gene symbols as all caps.

For example:
`NES-SAI2d15-OT_200514-01_Vehicle-1_DAPI+go` **PITX3** `-dk488+rb`
**ALDH1** `-dk555+mo` **TH** `-dk647**_200520_CF_10X-z2-3.tif`

However, what if we prefer to have the gene symbol to be capitalized
only on the first letter?

We have another piece of code that would capitalize the first letter
of any word:

```{r source_firstCaps}
source(here("hackathon-arenas-02","code","firstCaps.R"))
```

```{r source_firstCaps_no_here eval=FALSE}
source(file.path("hackathon-arenas-02","code","firstCaps.R"))
```

```{r firstCaps_demo}
args(firstCaps)

firstCaps("NURR1")
firstCaps("ras")
```

How would we add this into our name checking code?

Let's open the name_check.R code

It looks like there's a lot of stuff going on there. But if we scroll
down to line 72 or so, we might be able to find the section that is
capitalizing all the letters of the antibody target:

```{r uppercase_code eval=FALSE}
target = substr(antibodies[i],3,nchar(antibodies[i]))
if(grepl("^p[A-Z]",target)){
    ## Possible phosphorylated protein
    ## Converts the expected gene name to all uppercase,
    ##  but keeping the lower case "p" to indicate phosphorylated
    target = paste0("p",toupper(substr(target,2,nchar(target))))
}
else{
    ## This converts the expected gene name to all uppercase
    target = toupper(target)
}
```

If we look carefully, we can see a function called `toupper()`. What
does that do?

```{r toupper_test}
args(toupper)
toupper("NURR1")
toupper("ras")
```

So now we find where the code is making things uppercase. How would we
change it to first caps?

First, we want to copy the code into the `name_check.R` script (which we
will save as a new copy called `name_checker_firstCaps.R`). I like to
paste it at the top.

Then we will change the code to use the `firstCaps()` function instead
of `toupper()`, and then save the file.

```{r firstCaps_change eval=FALSE}
target = substr(antibodies[i],3,nchar(antibodies[i]))
if(grepl("^p[A-Z]",target)){
    ## Possible phosphorylated protein
    ## Converts the expected gene name to all uppercase,
    ##  but keeping the lower case "p" to indicate phosphorylated
    target = paste0("p",firstCaps(substr(target,2,nchar(target))))
}
else{
    ## This converts the expected gene name to all uppercase
    target = firstCaps(target)
}
```

Let's see what the code does now:

```{r firstCaps_nameChecker_source}
source(here("hackathon-arenas-02","code","name_checker_firstCaps.R"))
```

```{r firstCaps_nameChecker_no_here eval=FALSE}
source(file.path("hackathon-arenas-02","code","name_checker_firstCaps.R"))
```

```{r firstCaps_nameChecker_demo}
results <- check_file_names(file.path("hackathon-arenas-02","files_oliver","Good_file"))
```

Now you can see that the program is suggesting to rename the gene
symbols to only capitalize the first letter.

We hope that this might demonstrate how you can tweak and/or combine
pieces of code from different sources, and make a new piece of code
that would do what you want to do.
