---
title: "Arenas lab name checker usage"
author: "Oliver Tam and Julie Lowndes"
date: "6/26/2020"
output: html_document
---

## Introduction

This document is to keep track of our workflow using `name_checker.R`,
a script to check that files conform to the Arenas lab convention: 

We expect 8 sections, each separated by an underscore `_`:

1. Experimental name and researcher initials
2. Experiment date and experiment number
3. Condition and replicate number
4. Immunohistochemistry date
5. Dye, antibodies or transcript
6. Image capture date
7. Microscope type
8. Lens, zoom and image number

The first 3 sections would be used (in a future script) to sort the
file into subfolders.

Example:

`NES-SAI2d15-CS_200514-01_Vehicle-1_200517_DAPI+goPitx3-dk488+rbAldh1-dk555+moTh-dk647_200519_CF_10Xz1-1.tiff`

Where:

- Experiment name & initial: `NES-SAI2d15-CS`. experiment name is NES-SAI2d15, CS is Carmen Salto
- Experiment date and number: `200514-01`. 14 May 2020, number 1
- Condition & replicate: `Vehicle-1`. Vehicle condition, replicate 1
- Immunohistochemistry date: `200517`: 17 May 2020
- Dye/antibodies/transcript: `DAPI+goPITX3-dk488+rbALDH1-dk555+moTH-dk647`. Each element separated by `-`, if multiple separated by `+`
- Image capture date: `200520`: 20 May 2020
- Microscope type: `CF`. Confocal microscope 
- Lens, zoom & image number: `10X-z2-3`. 10x lens, 2 zoom, number 3.

## Code setup

Download or clone the GitHub folder. Move it somewhere you do your analyses (we can discuss good options later).

Open the GitHub folder from RStudio File > Open Project... or in Finder/Windows Explorer by double-clicking the `NDCN_hackathon.Rproj` file.

Navigate to the "arenas-02" folder.

We will work from this `name_checker_usage.Rmd` document today. It is
an R Markdown document, which combines simple text and R code. You can
use the Table of Contents at the bottom of the file to navigate. And
please add your own notes!

We will load one library, `here`, which reduces potential filepath issues.

```{r setup}
## checks if the `here` package is installed, if not, installs 
if(! requireNamespace("here",quietly=TRUE)){
  install.packages("here")
}

## load libraries
library(here) # load `here` package
```

## How to use the `name_checker` function

First we have to tell R we want to access code in the `name_checker.R` file, which we do with the `source()` function. This R script has a function called `name_checker()` that we'll use today.

Run the following code block if you have the `here` package:

```{r source_with_here}
source(here("arenas-02","code", "name_checker.R"))
```

If you have trouble with the `here` package, you can run the following (we'll provide both options throughout this demo):

```{r source_no_here, eval=FALSE}
source(file.path("arenas-02","code", "name_checker.R"))
```

This code gives you a list of parameters that the `name_checker()` function would take:

```{r usage}
args(name_checker)
```

The following are some examples on how we can call this function:

```{r examples, eval=FALSE}
results <- name_checker("my_folder")

results <- name_checker("my_folder", print2screen=FALSE)

```

Above, the user provides a folder (`my_folder`) containing files with names
that should be checked. The `name_checker()` function finds all the image files (ending in .czi .tif or .tiff) and checks their names. 

The first command saves the results to a variable (called `results`), and also
prints it to the screen. This is what we will be using for most of
this demo. 

The second command saves the results to a variable (`results`), but
doesn't print it to screen. This is useful if you don't want to see
the results on screen (especially if there are 100s of files to
process).

The third command provides more information for each file that it
checked, prints it to screen, and also saves it in a variable
(`detailed`). An example of this will be shown later.

## Oliver's demo

There is a file in the `files_test` folder, that is named according to
the Arenas lab convention. We can run the function to  check if it is named correctly.

```{r oliver_test}
results <- name_checker(here("arenas-02",'files_test'))
```

```{r oliver_test_no_here, eval=FALSE}
results <- name_checker(file.path("arenas-02",'files_test'))
```

The function indicates that the file is named according to the proposed
nomenclature

## Carmen's test run

In another folder, we had Carmen and Shanzheng from the Arenas lab try
to name a few files according to the proposed nomenclature. We have
also added some file names that might not perfectly fit. Let's see if
the function was able to check them.

```{r carmen_test}
source(here("arenas-02","code", "name_checker.R"))

results <- name_checker(here("arenas-02","files_Arenas"))
```

```{r carmen_test_no_here}
source(file.path("arenas-02","code", "name_checker.R"))

results <- name_checker(file.path("arenas-02","files_Arenas"))
```

Let's discuss the results.

## Questions?

Does anyone have any questions? Have you been following along with the code?

## Oliver features discussion

We've created this code after the Arenas lab talked together about what their current, personal naming conventions are, and what nice lab conventions could be. But this is a very iterative process to align the decide the conventions and write the code that works just like you want.

These are some updates/iterations we might discuss, and can also look at the code of what we would do to change it: 

- **underscores**. The 8 sections are separated by underscores. Do we still like this? What if we wanted to change it to dashes? 
- **FirstCaps**. Currently gene names are in ALLCAPS. But what if we wanted them in FirstCaps? 
- **dye/antibody**. Combining dyes and antibodies gets quite long. What are other options?
- **verbose**. We can also use the `verbose` argument to give more information to the user
- **check multiple folders**. The function currently operates on just one folder you provide. But you can add multiple!

### nderstanding and tweaking the function

Before we take a look at the code, this is just to remind you of the
nomenclature:

- 8 sections, each separated by an underscore `_`:

1. Experimental name and researcher initials
2. Experiment date and experiment number
3. Condition and replicate number
4. Immunohistochemistry date
5. Dye, antibodies or transcript
6. Image capture date
7. Microscope type
8. Lens, zoom and image number

And to remind you how we run this function:

```{r reminder, eval=FALSE}
results <- name_checker("my_folder")
```


Briefly, the function takes in the folder, and searches for all the
files in that folder. However, it only looks at files that are either
images (.tif) or those generated by the microscope (.lsm or .czi). The
code that does is in on ########TO DO###### Julie can write this if that's helpful


### underscores

Let's look in `name_checker.R` for the `clean_name` variable...

### FirstCaps

Here we want just the first letter capitalized instead of all caps.

In the antibody section of the file name, we are currently making all
the gene symbols as all caps.

For example:
`NES-SAI2d15-OT_200514-01_Vehicle-1_DAPI+go` **PITX3** `-dk488+rb`
**ALDH1** `-dk555+mo` **TH** `-dk647**_200520_CF_10X-z2-3.tif`

However, what if we prefer to have the gene symbol to be capitalized
only on the first letter?

We have another piece of code that would capitalize the first letter
of any word:

```{r source_firstCaps}
source(here("arenas-02","code","firstCaps.R"))
```

```{r source_firstCaps_no_here, eval=FALSE}
source(file.path("arenas-02","code","firstCaps.R"))
```

```{r firstCaps_demo}
args(firstCaps)

firstCaps("NURR1")
firstCaps("ras")
```

How would we add this into our name checking code?

Let's open the name_check.R code

It looks like there's a lot of stuff going on there. But if we scroll
down to line 72 or so, we might be able to find the section that is
capitalizing all the letters of the antibody target:

```{r uppercase_code, eval=FALSE}
target = substr(antibodies[i],3,nchar(antibodies[i]))
if(grepl("^p[A-Z]",target)){
    ## Possible phosphorylated protein
    ## Converts the expected gene name to all uppercase,
    ##  but keeping the lower case "p" to indicate phosphorylated
    target = paste0("p",toupper(substr(target,2,nchar(target))))
}
else{
    ## This converts the expected gene name to all uppercase
    target = toupper(target)
}
```

If we look carefully, we can see a function called `toupper()`. What
does that do?

```{r toupper_test}
args(toupper)
toupper("NURR1")
toupper("ras")
```

So now we find where the code is making things uppercase. How would we
change it to first caps?

First, we want to copy the code into the `name_check.R` script (which we
will save as a new copy called `name_checker_firstCaps.R`). I like to
paste it at the top.

Then we will change the code to use the `firstCaps()` function instead
of `toupper()`, and then save the file.

```{r firstCaps_change, eval=FALSE}
target = substr(antibodies[i],3,nchar(antibodies[i]))
if(grepl("^p[A-Z]",target)){
    ## Possible phosphorylated protein
    ## Converts the expected gene name to all uppercase,
    ##  but keeping the lower case "p" to indicate phosphorylated
    target = paste0("p",firstCaps(substr(target,2,nchar(target))))
}
else{
    ## This converts the expected gene name to all uppercase
    target = firstCaps(target)
}
```

Let's see what the code does now:

```{r firstCaps_nameChecker_source}
source(here("arenas-02","code","name_checker_firstCaps.R"))
```

```{r firstCaps_nameChecker_no_here, eval=FALSE}
source(file.path("arenas-02","code","name_checker_firstCaps.R"))
```

```{r firstCaps_nameChecker_demo}
results <- name_checker(file.path("arenas-02","files_test","Good_file"))
```

Now you can see that the function is suggesting to rename the gene
symbols to only capitalize the first letter.

We hope that this might demonstrate how you can tweak and/or combine
pieces of code from different sources, and make a new piece of code
that would do what you want to do.

### dye/antibody

TODO

### verbose

Is this just a name checker?

If we take a look at the third file, even though the function says that
it's named correctly, sometimes you might want to check what it's
actually finding. The code also has a way to do this by invoking the
`verbose` option:

```{r verbose}
results  <- name_checker(here("arenas-02","files_test","Good_file"),verbose=TRUE)
```

```{r verbose_no_here}
results  <- name_checker(file.path("arenas-02","files_test","Good_file"),verbose=TRUE)
```

From the results, you can see that it identified the following:
1. Destination folder
2. Experimental condition
3. Replicate number
4. Dye, antibody or transcripts being detected
5. Date of image capture
6. Type of microscope used
7. Lens used
8. Zoom level
9. Picture number

This information could be used in the future to auto-generate a
metadata file, or provide a way to "randomize" the file names

### Checking multiple folders

This function can be used as part of a larger workflow to check
multiple folders.
The following R code lists all the directory in the current folder
(which will include all three folders with image files), and will run
the function on each of those folders.
Furthermore, it will also save the results into a file called
`name_checking_log.txt` that you can look at once all the folders have been checked

```{r multiFolder, eval=FALSE}
all_dirs  <-  list.dirs(path=file.path("arenas-02"))
for(i in 1:length(all_dirs)){
  logfile  <-  c(paste("Current folder is:",all_dirs[i]),"")
  logfile  <-  c(logfile,name_checker(all_dirs[i]),print2screen=FALSE)
}

write.table(logfile,file.path("arenas-02","name_checking_log.txt"),sep="\n",quote=F,row.names=F,col.names=F)
```





